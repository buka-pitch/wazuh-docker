# Dockerfile.wazuh-dashboard-compatible
FROM ubuntu:20.04 as builder

# Install build dependencies
RUN apt-get update && apt-get install -y \
    curl \
    wget \
    gnupg \
    lsb-release \
    && rm -rf /var/lib/apt/lists/*

# Install Node.js (LTS version for compatibility)
RUN curl -fsSL https://deb.nodesource.com/setup_16.x | bash -
RUN apt-get install -y nodejs

# Install Yarn
RUN npm install -g yarn

# Clone Wazuh dashboard
WORKDIR /tmp
RUN git clone https://github.com/wazuh/wazuh-dashboard.git
WORKDIR /tmp/wazuh-dashboard
RUN git checkout v4.14.0

# Build with compatibility flags
ENV NODE_OPTIONS="--max-old-space-size=2048"
RUN yarn config set network-timeout 300000
RUN yarn osd bootstrap

# Build the dashboard
RUN yarn build --skip-os-packages

# Runtime stage
FROM ubuntu:20.04

# Install runtime dependencies
RUN apt-get update && apt-get install -y \
    curl \
    libnss3 \
    libatk-bridge2.0-0 \
    libgtk-3-0 \
    libgbm-dev \
    libxss1 \
    && rm -rf /var/lib/apt/lists/*

# Install Node.js runtime
RUN curl -fsSL https://deb.nodesource.com/setup_16.x | bash -
RUN apt-get install -y nodejs

# Create wazuh user
RUN groupadd -r wazuh && useradd -r -g wazuh wazuh

# Copy built dashboard
COPY --from=builder /tmp/wazuh-dashboard /usr/share/wazuh-dashboard
WORKDIR /usr/share/wazuh-dashboard

# Set permissions
RUN chown -R wazuh:wazuh /usr/share/wazuh-dashboard

# Create data directory
RUN mkdir -p /usr/share/wazuh-dashboard/data
RUN chown -R wazuh:wazuh /usr/share/wazuh-dashboard/data

# Expose port
EXPOSE 5601

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=2m --retries=3 \
    CMD curl -f http://localhost:5601/api/status || exit 1

# Switch to wazuh user
USER wazuh

# Start command
CMD ["node", "scripts/opensearch_dashboards", "--allow-root"]